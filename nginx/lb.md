# 负载均衡

## 目录

+ [4层负载均衡](#4层负载均衡)
+ [7层负载均衡](#7层负载均衡)

## 4层代理

4 层代理工作在 tcp/ip 层。客户端发送 syn 到 lb 时，lb 按照负载均衡算法选择一台后端 server，并将 IP 数据包中的 dst ip 更改为后端 server ip(DNAT)。当后端 server 返回 ack 时，将 IP 数据包中的 src ip 更改为 lb ip(SNAT)。所以客户端实际上是跟后端 server 建立了连接，lb 只充当 NAT 的作用，数据包的内容对 lb 来说是透明的。

## 7层代理

7 层代理工作在应用层。例如客户端先跟 lb 建立连接，lb 读取并解析数据包内容后，按照一定规则再转发到后端 server。

## 如何选择？

如上所述，4层代理的负载均衡是基于连接的。在 http/1.0/1.1 的应用场景下，一个 TCP 连接无法并行处理多个请求，所以在处理请求的过程中，会产生大量 tcp 连接，相对于数量较少的后端服务，负载均衡可以发挥作用。而对于 HTTP/2.0 来说，客户端与服务端之间只有单一的长连接存在，客户端所有请求均通过单一连接处理，此时基于多连接的 4 层 lb 就会失去均衡的能力。如果想对基于 HTTP/2.0 的应用(gRPC)做负载均衡，可以考虑如下两种方案：

1. 客户端获取后端服务列表，在请求端做均衡。例如使用 ectd 存储并动态监听服务地址的变更，或者直接使用 k8s 提供的 本地 dns 服务。
2. 走7层代理。例如 envoy

## 参考

https://www.nginx.com/resources/glossary/layer-4-load-balancing/
